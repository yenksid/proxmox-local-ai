<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local AI Node</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg-color: #0d1117; --chat-bg: #161b22; --user-msg: #238636; --ai-msg: #1f6feb; --text-color: #c9d1d9; --font-mono: 'Courier New', Courier, monospace; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background-color: var(--chat-bg); padding: 1rem; border-bottom: 1px solid #30363d; text-align: center; font-family: var(--font-mono); font-weight: bold; color: #58a6ff; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 8px; line-height: 1.5; word-wrap: break-word; }
        .user { align-self: flex-end; background-color: var(--user-msg); color: white; }
        .ai { align-self: flex-start; background-color: var(--chat-bg); border: 1px solid #30363d; }
        .json-badge { font-size: 0.7em; background: #d29922; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 5px; }
        #input-area { background-color: var(--chat-bg); padding: 20px; border-top: 1px solid #30363d; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; background-color: #0d1117; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 6px; font-family: var(--font-mono); }
        button { background-color: #238636; color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #2ea043; }
        button:disabled { background-color: #30363d; cursor: wait; }
        pre { background: #000; padding: 10px; border-radius: 5px; overflow-x: auto; }
        code { font-family: var(--font-mono); }
    </style>
</head>
<body>
<header>âš¡ LOCAL AI NODE | Llama 3.2 3B</header>
<div id="chat-container">
    <div class="message ai">System ready. Running in LXC. Efficiency protocols active.<br>How can I assist you?</div>
</div>
<div id="input-area">
    <input type="text" id="user-input" placeholder="Type a command or query..." autocomplete="off">
    <button id="send-btn">SEND</button>
</div>
<script>
    const chatContainer = document.getElementById('chat-container');
    const inputField = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    function parseAIResponse(text) {
        text = text.trim();
        if (text.startsWith('{') && text.endsWith('}')) {
            try {
                const data = JSON.parse(text);
                if (data.parameters) {
                    let cleanContent = data.parameters.content || JSON.stringify(data.parameters, null, 2);
                    return `<span class="json-badge">TOOL OUTPUT</span><br>` + marked.parse(cleanContent);
                }
                return `<span class="json-badge">JSON DATA</span><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) { return marked.parse(text); }
        }
        return marked.parse(text);
    }

    async function sendMessage() {
        const text = inputField.value.trim();
        if (!text) return;
        addMessage(text, 'user');
        inputField.value = ''; inputField.disabled = true; sendBtn.disabled = true;
        const loadingId = addMessage("Thinking...", 'ai', true);
        try {
            const response = await fetch('/completion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: `<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\nYou are a helpful AI assistant running on a local Proxmox server. Keep answers concise.<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n${text}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n`,
                    n_predict: 512, temperature: 0.7, stop: ["<|eot_id|>"]
                })
            });
            const data = await response.json();
            document.getElementById(loadingId).remove();
            const aiText = parseAIResponse(data.content);
            addMessage(aiText, 'ai', false, true);
        } catch (error) {
            document.getElementById(loadingId).remove();
            addMessage("Error connecting to Local AI: " + error.message, 'ai');
        }
        inputField.disabled = false; sendBtn.disabled = false; inputField.focus();
    }
    function addMessage(text, sender, isTemp = false, isHTML = false) {
        const div = document.createElement('div'); div.className = `message ${sender}`;
        if (isTemp) div.id = 'msg-' + Date.now();
        if (isHTML) div.innerHTML = text; else div.textContent = text;
        chatContainer.appendChild(div); chatContainer.scrollTop = chatContainer.scrollHeight;
        return div.id;
    }
    sendBtn.addEventListener('click', sendMessage);
    inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>
